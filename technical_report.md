# KYCC Application Technical Report

**Version:** 1.0.0
**Date:** December 17, 2025
**Generated By:** Antigravity AI

---

## 1. Executive Summary

**Know Your Customer's Customer (KYCC)** is an intelligent, automated credit scoring platform designed for supply chain networks. It leverages an "Expert Scorecard" approach combined with AI/ML to predict financial risk. The system evolves by learning from transaction history to refine its scoring models while maintaining explainability.

**Core Philosophy:** "The Scorecard is King, Artificial Intelligence is the Advisor." - The system uses transparent rules (Scorecard) for decisions but uses ML to suggest improvements to those rules.

---

## 2. System Architecture

The application follows a modern microservices-style architecture, containerized with Docker.

### High-Level Stack
*   **Frontend:** React (Vite) - User Interface for visualization.
*   **Backend:** FastAPI (Python) - REST API for data access and scoring requests.
*   **Database:** PostgreSQL 15 - Relational storage for all data.
*   **Orchestration:** Dagster - Manages the data pipeline (Ingestion, Training, Scoring).
*   **Infrastructure:** Docker Compose - Orchestrates services.

### Service Interaction
1.  **Frontend** talks to **Backend API** (FastAPI).
2.  **Backend API** reads/writes to **PostgreSQL**.
3.  **Dagster** runs background jobs (Pipeline) which read/write to **PostgreSQL**.
4.  **ML Models** are trained by Dagster and stored in the Database/Registry.

---

## 3. Database Schema (PostgreSQL)

The database is managed via **Alembic** migrations and **SQLAlchemy** ORM.

### Core Entities (`backend/app/models/models.py`)
*   **`Party`**: Represents a company or individual.
    *   Attributes: `name`, `party_type` (Supplier, Retailer, etc.), `tax_id`, `kyc_verified`.
*   **`Relationship`**: Edges in the supply chain graph.
    *   Attributes: `from_party_id`, `to_party_id`, `relationship_type` (Supplies To, etc.).
*   **`Transaction`**: Financial movements.
    *   Attributes: `amount`, `transaction_type` (Invoice, Payment), `date`.
*   **`Account`**: Bank accounts tied to parties.

### Credit Scoring & ML Entities
*   **`ScoreRequest`**: Log of every scoring attempt.
    *   Stores: `final_score`, `model_version`, `features_snapshot`, `decision`.
*   **`ScorecardVersion`**: Versioned definitions of the expert scorecard.
    *   Stores: `weights` (JSON), `status` (active/retired), `source` (expert/ml_refined).
*   **`feature`**: Computed features for each party.
    *   Stores: `feature_name`, `feature_value`, `valid_from`, `valid_to`.
*   **`GroundTruthLabel`**: Training labels for ML.
    *   Stores: `will_default` (0/1), `risk_level`, `dataset_batch`.
*   **`ModelRegistry`**: Registry of trained ML models.
    *   Stores: `performance_metrics` (AUC, F1), `model_config` (weights).

---

## 4. Data Pipeline (Dagster)

The pipeline is the heart of the system, defined in `backend/dagster_home/definitions.py`. It runs in "Batches" (e.g., `BATCH_001`).

### Pipeline Stages

#### 1. Ingestion (`ingest_synthetic_batch`)
*   **Input:** JSON files (e.g., `data/BATCH_001_profiles.json`).
*   **Action:** Loads raw profiles, transactions, and relationships into the Database.
*   **Validation:** `validate_ingestion` checks row counts.

#### 2. Feature Extraction
*   **Assets:** `kyc_features`, `transaction_features`, `network_features`.
*   **Logic:** `FeaturePipelineService` computes metrics like:
    *   *KYC:* Age of business, verification status.
    *   *Transaction:* Volume, average amount, payment regularity.
    *   *Network:* Centrality, number of suppliers.
*   **Convergence:** `features_all` ensures all features are ready.
*   **Validation:** `validate_features` checks for missing values and data quality.

#### 3. Label Generation (`generate_scorecard_labels`)
*   **Purpose:** Bootstrapping labels for training when real default history is missing.
*   **Logic:** Uses the *current* Scorecard (v1.0) to score parties. The bottom 5% are labeled as "High Risk" (defaults) to create a training set.
*   **Service:** `LabelGenerationService`.

#### 4. Model Training (`train_model_asset`)
*   **Input:** Matrix of Features (X) and Labels (y) built by `FeatureMatrixBuilder`.
*   **Model:** Logistic Regression.
*   **Output:** Trained model and performance metrics (AUC, F1).

#### 5. Scorecard Refinement (`refine_scorecard`)
*   **The "Student & Teacher" Loop:**
    *   Extracts coefficients from the trained Logistic Regression model.
    *   Converts them into human-readable Scorecard Weights.
    *   **Quality Gates:**
        *   ML AUC must be >= 0.7.
        *   New model must outperform the current production scorecard.
    *   **Action:** If gates pass, creates a new `ScorecardVersion` (v1.1) and sets it to `active`.

#### 6. Scoring (`score_batch`)
*   **Action:** Scores the current batch using the *newly active* Scorecard.
*   **Artifact:** Populates `score_requests` table with final decisions (Approved/Rejected).

---

## 5. Backend Services (`backend/app/services`)

The logic is encapsulated in service classes:

*   **`ScorecardEngine`**:
    *   Calculates scores based on a config dictionary (weights).
    *   Pure logic, no DB side effects.
*   **`ScoringService`**:
    *   Orchestrates the scoring process: fetches features -> calls Engine -> saves `ScoreRequest`.
*   **`FeaturePipelineService`**:
    *   Manages the extraction of features from raw data.
*   **`ModelTrainingService`**:
    *   Handles Scikit-Learn model training and evaluation.
*   **`ScorecardVersionService`**:
    *   Manages the lifecycle of scorecards (CRUD, activation, retirement).
*   **`LabelGenerationService`**:
    *   Applies rules to generate synthetic ground truth.

---

## 6. Frontend Application

*   **Framework:** React (Vite).
*   **Structure:**
    *   `src/components`: Reusable UI elements.
    *   `src/pages`: Main views (Dashboard, Network Graph, Scorecard View).
    *   `src/api`: Axios wrappers for backend endpoints.
*   **Key Features:**
    *   Visualization of the Supply Chain Graph.
    *   Dashboard showing current Credit Scores and Risk Bands.
    *   Admin view to see Scorecard Versions and ML performance.

---

## 7. Infrastructure & Deviation

*   **Docker Compose**:
    *   `postgres`: Persists data to volume `kycc_pgdata`.
    *   `backend`: Exposes Port `8000`. Healthcheck on `/health`.
    *   `dagster`: Exposes Port `3000` (UI).
*   **Configuration**:
    *   Managed via `.env` files.
    *   Key vars: `POSTGRES_USER`, `DATABASE_URL`, `DAGSTER_HOME`.

---

## 8. Operational Commands

*   **Start System:** `docker compose up -d`
*   **Run Pipeline (Manual):**
    ```bash
    docker exec -it kycc-backend-1 python scripts/run_full_pipeline.py
    ```
*   **Access API Docs:** `http://localhost:8000/docs`
*   **Access Dagster UI:** `http://localhost:3000`
